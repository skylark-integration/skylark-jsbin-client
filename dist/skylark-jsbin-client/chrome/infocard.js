/**
 * skylark-jsbin-client - A version of jsbin-editor  that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-jsbin-client/
 * @license MIT
 */
define(["skylark-jquery","../jsbin","./analytics"],function(t,e,n){if("EventSource"in global)return i();function i(){"use strict";if(!e.embed){var i=t("#infocard"),a=i.find("header"),s=a.find("canvas")[0],o=spinner(s),r=e.panels.named.html,c=0,d=null,u={head:/<head(.*)\n/i,meta:/(<meta name="description" content=")([^"]*)/im,title:/<title>(.*)<\/title>/im};0!==i.length&&(i.find(".settings")&&(i.find("#title").on("input",function(){f("title");var t=r.getCode(),n=this.value;p(t.replace(u.title,function(t,e){return"<title>"+n.replace(/</g,"&lt;").replace(/>/g,"&gt;")+"</title>"})),e.state.updateSettings({title:this.value})}),i.find("#description").on("input",function(){f("meta");var t=r.getCode(),n=this.value;p(t.replace(u.meta,function(t,e){return e+n.replace(/"/g,"&quot;")})),e.state.updateSettings({description:this.value})})),function(){function s(){var n={};i.find(".row").each(function(){t(this).find('[name="header-value"]').val().trim()&&(n[t(this).find("input:first").val()]=t(this).find("input:last").val())}),e.state.updateSettings({headers:n},"PUT")}t("a.more").add(a).on("mousedown touchstart",function(t){var e;infocardVisible=!infocardVisible,hideOpen(),t.preventDefault(),n.infocard("click","no-result"),i.toggleClass(function(t,n){return e=-1===n.indexOf("open")?"open":"close",infocardVisible="open"===e,"open"}).trigger(e)}),i.one("open",function(){var n=t("#status").data("status")||200;t.getJSON(e.static+"/js/http-codes.json",function(i){var a="";i.forEach(function(t){a+='<option value="'+t.code+'">'+t.string+"</option>"}),t("#status").html(a).val(n).on("change",function(){e.state.updateSettings({statusCode:this.value})})})}).on("close",function(){});var o=i.find("#headers");i.on("click","#headers button",function(t){t.preventDefault();var e=o.find("span:last");s();var n=e.clone(!0);e.before(n),e.find("input").val("").eq(0).focus()}),i.on("input",".row input",function(){s(t(this).closest(".row"))})}(),v(),$document.bind("saved",v))}function l(t,e){var n=e?JSON.parse(e):JSON.parse(t.data);if(n.connections>0&&0===c&&i.addClass("viewers"),c!==n.connections){var s=a.find(".viewers b").removeClass("up down").html("<b>"+n.connections+"<br>"+c+"<br>"+n.connections+"</b>"),o=c>n.connections?"down":"up";setTimeout(function(){s.addClass(o)},0)}0===(c=n.connections)&&setTimeout(function(){i.removeClass("viewers")},250)}function m(t){window.EventSource&&t&&(d&&d.close(),(d=new EventSource(e.getURL()+"/stats?checksum="+e.state.checksum)).addEventListener("stats",e.throttle(l,1e3)))}function f(t){r.editor;var n=r.getCode();if("meta"===t&&(t='meta name="description'),-1===n.indexOf("<"+t)){var i=function(t,n){var i=e.state.processors.html;if(n=n.replace(/"/g,"&quot;"),"title"===t)return"jade"===i?"title "+n+"\n":"<title>"+n+"</title>\n";if("description"===t)return"jade"===i?'meta(name="description", content="'+n+'")\n':'<meta name="description" content="'+n+'">\n';return n}("title"===t?"title":"description","");n=u.head.test(n)?n.replace(u.head,"<head$1\n"+i):i+n,r.setCode(n)}}function p(t){var n=null,i=null,a=r.editor,s=a.somethingSelected();e.panels.named.html.visible&&(s&&(n=a.listSelections()),i=a.getCursor()),r.setCode(t),e.panels.named.html.visible&&(e.mobile||a.setCursor(i),s&&a.setSelections(n))}function v(n){var s=e.state.metadata||{},r=[],c=!1;if(s.name&&(a.find(".name b").html(s.name),a.find("img").attr("src",s.avatar),r.push(s.name)),(e.state.checksum||e.user&&s.name===e.user.name)&&(c=!0,r.push("author")),o&&o.stop(),e.state.streaming&&!0!==c?!1===c&&(a.find("time").html("Streaming"),r.push("streaming"),o&&o.start()):a.find("time").html(n?"just now":prettyDate(s.last_updated)),e.checksum||r.push("meta"),s.pro&&r.push("pro"),a.find(".visibility").text(s.visibility),"private"===s.visibility?r.push("private"):"public"===s.visibility&&r.push("public"),e.state.code&&i.addClass(r.join(" ")).parent().removeAttr("hidden"),e.state.streaming)if(window.EventSource&&c){m(c),function(t){var e="hidden"in document?"hidden":"webkitHidden"in document?"webkitHidden":"mozHidden"in document?"mozHidden":null;if("visibilityState"in document||("webkitVisibilityState"in document||"mozVisibilityState"in document)){var n=e.replace(/hidden/i,"visibilitychange");document.addEventListener(n,function(){document[e]?d.close():m(t)})}}(c);var u=e.getURL();e.$document.on("saved",function(){var t=window.location.toString();u!==t&&(d.close(),m(c))})}else!0===e.saveDisabled&&"/edit"===window.location.pathname.slice(-5)&&(t.getScript(e.static+"/js/spike.js?"+e.version),e.$document.on("stats",e.throttle(l,1e3)))}}t.getScript(e.static+"/js/vendor/eventsource.js",i)});
//# sourceMappingURL=../sourcemaps/chrome/infocard.js.map
