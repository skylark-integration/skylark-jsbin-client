/**
 * skylark-jsbin-client - A version of jsbin-editor  that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-jsbin-client/
 * @license MIT
 */
define(["skylark-jquery","skylark-jsbin-chrome/hideOpen","../jsbin","./analytics"],function(t,e,n,i){if("EventSource"in global)return a();function a(){"use strict";if(!n.embed){var a=t("#infocard"),s=a.find("header"),o=s.find("canvas")[0],r=spinner(o),c=n.panels.named.html,d=0,u=null,l={head:/<head(.*)\n/i,meta:/(<meta name="description" content=")([^"]*)/im,title:/<title>(.*)<\/title>/im};0!==a.length&&(a.find(".settings")&&(a.find("#title").on("input",function(){p("title");var t=c.getCode(),e=this.value;v(t.replace(l.title,function(t,n){return"<title>"+e.replace(/</g,"&lt;").replace(/>/g,"&gt;")+"</title>"})),n.state.updateSettings({title:this.value})}),a.find("#description").on("input",function(){p("meta");var t=c.getCode(),e=this.value;v(t.replace(l.meta,function(t,n){return n+e.replace(/"/g,"&quot;")})),n.state.updateSettings({description:this.value})})),function(){function o(){var e={};a.find(".row").each(function(){t(this).find('[name="header-value"]').val().trim()&&(e[t(this).find("input:first").val()]=t(this).find("input:last").val())}),n.state.updateSettings({headers:e},"PUT")}t("a.more").add(s).on("mousedown touchstart",function(t){var n;infocardVisible=!infocardVisible,e(),t.preventDefault(),i.infocard("click","no-result"),a.toggleClass(function(t,e){return n=-1===e.indexOf("open")?"open":"close",infocardVisible="open"===n,"open"}).trigger(n)}),a.one("open",function(){var e=t("#status").data("status")||200;t.getJSON(n.static+"/js/http-codes.json",function(i){var a="";i.forEach(function(t){a+='<option value="'+t.code+'">'+t.string+"</option>"}),t("#status").html(a).val(e).on("change",function(){n.state.updateSettings({statusCode:this.value})})})}).on("close",function(){});var r=a.find("#headers");a.on("click","#headers button",function(t){t.preventDefault();var e=r.find("span:last");o();var n=e.clone(!0);e.before(n),e.find("input").val("").eq(0).focus()}),a.on("input",".row input",function(){o(t(this).closest(".row"))})}(),h(),$document.bind("saved",h))}function m(t,e){var n=e?JSON.parse(e):JSON.parse(t.data);if(n.connections>0&&0===d&&a.addClass("viewers"),d!==n.connections){var i=s.find(".viewers b").removeClass("up down").html("<b>"+n.connections+"<br>"+d+"<br>"+n.connections+"</b>"),o=d>n.connections?"down":"up";setTimeout(function(){i.addClass(o)},0)}0===(d=n.connections)&&setTimeout(function(){a.removeClass("viewers")},250)}function f(t){window.EventSource&&t&&(u&&u.close(),(u=new EventSource(n.getURL()+"/stats?checksum="+n.state.checksum)).addEventListener("stats",n.throttle(m,1e3)))}function p(t){c.editor;var e=c.getCode();if("meta"===t&&(t='meta name="description'),-1===e.indexOf("<"+t)){var i=function(t,e){var i=n.state.processors.html;if(e=e.replace(/"/g,"&quot;"),"title"===t)return"jade"===i?"title "+e+"\n":"<title>"+e+"</title>\n";if("description"===t)return"jade"===i?'meta(name="description", content="'+e+'")\n':'<meta name="description" content="'+e+'">\n';return e}("title"===t?"title":"description","");e=l.head.test(e)?e.replace(l.head,"<head$1\n"+i):i+e,c.setCode(e)}}function v(t){var e=null,i=null,a=c.editor,s=a.somethingSelected();n.panels.named.html.visible&&(s&&(e=a.listSelections()),i=a.getCursor()),c.setCode(t),n.panels.named.html.visible&&(n.mobile||a.setCursor(i),s&&a.setSelections(e))}function h(e){var i=n.state.metadata||{},o=[],c=!1;if(i.name&&(s.find(".name b").html(i.name),s.find("img").attr("src",i.avatar),o.push(i.name)),(n.state.checksum||n.user&&i.name===n.user.name)&&(c=!0,o.push("author")),r&&r.stop(),n.state.streaming&&!0!==c?!1===c&&(s.find("time").html("Streaming"),o.push("streaming"),r&&r.start()):s.find("time").html(e?"just now":prettyDate(i.last_updated)),n.checksum||o.push("meta"),i.pro&&o.push("pro"),s.find(".visibility").text(i.visibility),"private"===i.visibility?o.push("private"):"public"===i.visibility&&o.push("public"),n.state.code&&a.addClass(o.join(" ")).parent().removeAttr("hidden"),n.state.streaming)if(window.EventSource&&c){f(c),function(t){var e="hidden"in document?"hidden":"webkitHidden"in document?"webkitHidden":"mozHidden"in document?"mozHidden":null;if("visibilityState"in document||("webkitVisibilityState"in document||"mozVisibilityState"in document)){var n=e.replace(/hidden/i,"visibilitychange");document.addEventListener(n,function(){document[e]?u.close():f(t)})}}(c);var d=n.getURL();n.$document.on("saved",function(){var t=window.location.toString();d!==t&&(u.close(),f(c))})}else!0===n.saveDisabled&&"/edit"===window.location.pathname.slice(-5)&&(t.getScript(n.static+"/js/spike.js?"+n.version),n.$document.on("stats",n.throttle(m,1e3)))}}t.getScript(n.static+"/js/vendor/eventsource.js",a)});
//# sourceMappingURL=../sourcemaps/chrome/infocard.js.map
