/**
 * skylark-jsbin-client - A version of jsbin-editor  that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-jsbin-client/
 * @license MIT
 */
define(["skylark-jquery","../jsbin"],function(t,e){if("EventSource"in global)return n();function n(){"use strict";if(!e.embed){var n=t("#infocard"),i=n.find("header"),a=i.find("canvas")[0],s=spinner(a),o=e.panels.panels.html,r=0,c=null,d={head:/<head(.*)\n/i,meta:/(<meta name="description" content=")([^"]*)/im,title:/<title>(.*)<\/title>/im};0!==n.length&&(n.find(".settings")&&(n.find("#title").on("input",function(){p("title");var t=o.getCode(),n=this.value;f(t.replace(d.title,function(t,e){return"<title>"+n.replace(/</g,"&lt;").replace(/>/g,"&gt;")+"</title>"})),e.state.updateSettings({title:this.value})}),n.find("#description").on("input",function(){p("meta");var t=o.getCode(),n=this.value;f(t.replace(d.meta,function(t,e){return e+n.replace(/"/g,"&quot;")})),e.state.updateSettings({description:this.value})})),function(){function a(){var i={};n.find(".row").each(function(){t(this).find('[name="header-value"]').val().trim()&&(i[t(this).find("input:first").val()]=t(this).find("input:last").val())}),e.state.updateSettings({headers:i},"PUT")}t("a.more").add(i).on("mousedown touchstart",function(t){var e;infocardVisible=!infocardVisible,hideOpen(),t.preventDefault(),analytics.infocard("click","no-result"),n.toggleClass(function(t,n){return e=-1===n.indexOf("open")?"open":"close",infocardVisible="open"===e,"open"}).trigger(e)}),n.one("open",function(){var n=t("#status").data("status")||200;t.getJSON(e.static+"/js/http-codes.json",function(i){var a="";i.forEach(function(t){a+='<option value="'+t.code+'">'+t.string+"</option>"}),t("#status").html(a).val(n).on("change",function(){e.state.updateSettings({statusCode:this.value})})})}).on("close",function(){});var s=n.find("#headers");n.on("click","#headers button",function(t){t.preventDefault();var e=s.find("span:last");a();var n=e.clone(!0);e.before(n),e.find("input").val("").eq(0).focus()}),n.on("input",".row input",function(){a(t(this).closest(".row"))})}(),m(),$document.bind("saved",m))}function l(t,e){var a=e?JSON.parse(e):JSON.parse(t.data);if(a.connections>0&&0===r&&n.addClass("viewers"),r!==a.connections){var s=i.find(".viewers b").removeClass("up down").html("<b>"+a.connections+"<br>"+r+"<br>"+a.connections+"</b>"),o=r>a.connections?"down":"up";setTimeout(function(){s.addClass(o)},0)}0===(r=a.connections)&&setTimeout(function(){n.removeClass("viewers")},250)}function u(t){window.EventSource&&t&&(c&&c.close(),(c=new EventSource(e.getURL()+"/stats?checksum="+e.state.checksum)).addEventListener("stats",throttle(l,1e3)))}function p(t){o.editor;var n=o.getCode();if("meta"===t&&(t='meta name="description'),-1===n.indexOf("<"+t)){var i=function(t,n){var i=e.state.processors.html;if(n=n.replace(/"/g,"&quot;"),"title"===t)return"jade"===i?"title "+n+"\n":"<title>"+n+"</title>\n";if("description"===t)return"jade"===i?'meta(name="description", content="'+n+'")\n':'<meta name="description" content="'+n+'">\n';return n}("title"===t?"title":"description","");n=d.head.test(n)?n.replace(d.head,"<head$1\n"+i):i+n,o.setCode(n)}}function f(t){var n=null,i=null,a=o.editor,s=a.somethingSelected();e.panels.panels.html.visible&&(s&&(n=a.listSelections()),i=a.getCursor()),o.setCode(t),e.panels.panels.html.visible&&(e.mobile||a.setCursor(i),s&&a.setSelections(n))}function m(a){var o=e.state.metadata||{},r=[],d=!1;if(o.name&&(i.find(".name b").html(o.name),i.find("img").attr("src",o.avatar),r.push(o.name)),(e.state.checksum||e.user&&o.name===e.user.name)&&(d=!0,r.push("author")),s&&s.stop(),e.state.streaming&&!0!==d?!1===d&&(i.find("time").html("Streaming"),r.push("streaming"),s&&s.start()):i.find("time").html(a?"just now":prettyDate(o.last_updated)),e.checksum||r.push("meta"),o.pro&&r.push("pro"),i.find(".visibility").text(o.visibility),"private"===o.visibility?r.push("private"):"public"===o.visibility&&r.push("public"),e.state.code&&n.addClass(r.join(" ")).parent().removeAttr("hidden"),e.state.streaming)if(window.EventSource&&d){u(d),function(t){var e="hidden"in document?"hidden":"webkitHidden"in document?"webkitHidden":"mozHidden"in document?"mozHidden":null;if("visibilityState"in document||("webkitVisibilityState"in document||"mozVisibilityState"in document)){var n=e.replace(/hidden/i,"visibilitychange");document.addEventListener(n,function(){document[e]?c.close():u(t)})}}(d);var p=e.getURL();$document.on("saved",function(){var t=window.location.toString();p!==t&&(c.close(),u(d))})}else!0===e.saveDisabled&&"/edit"===window.location.pathname.slice(-5)&&(t.getScript(e.static+"/js/spike.js?"+e.version),$document.on("stats",throttle(l,1e3)))}}t.getScript(e.static+"/js/vendor/eventsource.js",n)});
//# sourceMappingURL=../sourcemaps/chrome/infocard.js.map
