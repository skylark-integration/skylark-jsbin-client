/**
 * skylark-jsbin-client - A version of jsbin-editor  that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-jsbin-client/
 * @license MIT
 */
define(["skylark-jquery","skylark-jsbin-base/storage","skylark-jsbin-coder/editors/panels","../jsbin","./analytics"],function(e,t,n,s,a){var i={todo:{html:!1,css:!1,javascript:!1},_inprogress:!1,inprogress:function(e){if(void 0===e)return i._inprogress;if(i._inprogress=e,!1===e){var t=["html","css","javascript"],n=function(){var e=t.pop();e&&i.todo[e]?(i._inprogress=!0,f(e,n),i.todo[e]=!1):e&&n()};n()}}};function o(e){var t=s.panels.named.html.getCode(),n="";return-1===t.indexOf("<"+e)?n:"title"!==e&&"meta"!==e?(console.error("getTagContent for "+e+" is not supported"),n):(t.replace(o.re[e],function(t,s,a){n="title"===e?s:a}),n)}o.re={meta:/(<meta name="description" content=")([^"]*)/im,title:/<title>(.*)<\/title>/im},e("a.save").click(function(e){e.preventDefault(),a.milestone();var t=!0;return!0===s.saveDisabled&&(t=!1),(s.state.changed||s.mobile||!s.owner())&&w("save",t),!1});var r=e("#share .link"),c=e("#sharemenu #sharepanels input"),d=e("#sharemenu .share-split").length;function l(){"use strict";if(!d){var e={live:"output",javascript:"js",css:"css",html:"html",console:"console"},t=c.filter(":checked").map(function(){return e[this.getAttribute("data-panel")]}).get().join(",");r.each(function(){var e=this.getAttribute("data-path"),a=s.getURL({withRevision:!0})+e+(t&&"livepreview"!==this.id?"?"+t:""),i=this.nodeName,o=n.getHighlightLines();o&&(o="#"+o),"A"===i?this.href=a:"INPUT"===i?(this.value=a,"/edit"===e&&(this.value+=o)):"TEXTAREA"===i&&(this.value=('<a class="jsbin-embed" href="'+a+o+'">'+s.documentTitle+'</a><script src="'+s.static+'/js/embed.js"><\/script>').replace(/<>"&/g,function(e){return{"<":"&lt;",">":"&gt;",'"':"&quot;","&":"&amp;"}[e]}))})}}e("#sharemenu").bind("open",l),e("#sharebintype input[type=radio]").on("click",function(){"snapshot"===this.value&&(s.state.checksum=!1,m=!1),l()});var p=null;function u(e,t){if(!t||"html"===t.panelId){var n=s.panels.named.html.getCode();if(p!==n){p=n;var a=o("meta");a!==s.state.description&&(s.state.description=a,s.state.updateSettings({description:a}));var i=o("title");i!==s.state.title&&(s.state.title=i,s.state.updateSettings({title:i}),s.documentTitle=i,s.documentTitle?document.title=s.documentTitle+" - "+s.name:document.title=s.name)}}}s.$document.on("saveComplete",u),s.$document.on("saved",function(){s.state.changed=!1,l(),e('#sharebintype input[type=radio][value="realtime"]').prop("checked",!0),r.closest(".menu").removeClass("hidden"),e("#jsbinurl").attr("href",s.getURL()).removeClass("hidden"),e("#clone").removeClass("hidden"),u()});var m=s.state.checksum||t.sessionStorage.getItem("checksum")||!1;function h(t,n){413===t.status?(e("#tip p").html("Sorry this bin is too large for us to save"),e(document.documentElement).addClass("showtip")):403===t.status?s.$document.trigger("tip",{type:"error",content:"I think there's something wrong with your session and I'm unable to save. <a href=\""+window.location+'"><strong>Refresh to fix this</strong></a>, you <strong>will not</strong> lose your code.'}):n&&(n&&v[n].text("Saving...").animate({opacity:1},100),window._console.error({message:"Warning: Something went wrong while saving. Your most recent work is not saved."}))}if(s.state.checksum=m,m?e("#share div.disabled").removeClass("disabled").unbind("click mousedown mouseup"):e("#share div.disabled").one("click",function(t){t.preventDefault(),e("a.save").click()}),s.$document.one("saved",function(){e("#share div.disabled").removeClass("disabled").unbind("click mousedown mouseup")}),s.saveDisabled)s.$document.one("jsbinReady",function(){"use strict";var e=!1;s.embed||s.sandbox||s.$document.on("codeChange.live",function(t,n){if(!n.onload&&!e&&"setValue"!==n.origin){e=!0;var a=-1!==navigator.userAgent.indexOf(" Mac "),i=a?"⌘":"ctrl",o=a?"⇧":"shift",r=a?"":"+";s.$document.trigger("tip",{type:"notification",content:'You\'re currently viewing someone else\'s live stream, but you can <strong><a class="clone" href="'+s.root+'/clone">clone your own copy</a></strong> ('+i+r+o+r+"S) at any time to save your edits"})}})});else{e(".code.panel .label .name").append('<span class="saved">Saved</span>');var v={html:e(".panel.html .name span.saved"),javascript:e(".panel.javascript .name span.saved"),css:e(".panel.css .name span.saved")};s.$document.bind("jsbinReady",function(){s.state.changed=!1,s.panels.allEditors(function(e){e.on("processor",function(){s.root!==s.getURL()&&s.$document.trigger("codeChange",[{panelId:e.id}])})}),s.$document.bind("codeChange",function(e,t){s.state.changed=!0,v[t.panelId]&&v[t.panelId].css({opacity:0}).stop(!0,!0)}),s.$document.bind("saveComplete",s.throttle(function(e,t){v[t.panelId].text("Saved").stop(!0,!0).animate({opacity:1},100).delay(1200).animate({opacity:0},500)},500)),s.$document.bind("codeChange",s.throttle(function(e,t){if(t.panelId&&!s.state.deleted){var n=t.panelId;s.panels.savecontent(),i.inprogress()?i.todo[n]=!0:(i.inprogress(!0),m&&s.state.code?f(n):w("save",!0))}},3e4))})}function g(e,t){t.compressed=e,e.split(",").forEach(function(e){t[e]=LZString.compressToUTF16(t[e])})}function f(t,a){var o={};s.state.processors&&(o.processors=s.state.processors);var r={code:s.state.code,revision:s.state.revision,method:"update",panel:t,content:n.named[t].getCode(),checksum:s.saveChecksum,settings:JSON.stringify(o)};s.settings.useCompression&&"http:"===location.protocol&&g("content",r),s.state.processors[t]&&s.state.processors[t]!==t&&s.state.cache[t]&&(r.processed=s.state.cache[t].result),e.ajax({url:s.getURL({withRevision:!0})+"/save",data:r,type:"post",dataType:"json",headers:{Accept:"application/json"},success:function(e){s.$document.trigger("saveComplete",{panelId:t}),e.error?w("save",!0,function(){}):s.state.latest=!0},error:function(e){h(e,t)},complete:function(){i.inprogress(!1),a&&a()}})}function y(e){return e.preventDefault(),s.panels.save(),a.clone(),b("save,new").submit(),!1}function b(t){var n=e("form#saveform").empty().append('<input type="hidden" name="javascript" />').append('<input type="hidden" name="html" />').append('<input type="hidden" name="css" />').append('<input type="hidden" name="method" />').append('<input type="hidden" name="_csrf" value="'+s.state.token+'" />').append('<input type="hidden" name="settings" />').append('<input type="hidden" name="checksum" />'),a={};return s.state.processors&&(a.processors=s.state.processors),"welcome"===s.state.code&&n.attr("action","/save"),n.find("input[name=settings]").val(JSON.stringify(a)),n.find("input[name=javascript]").val(editors.javascript.getCode()),n.find("input[name=css]").val(editors.css.getCode()),n.find("input[name=html]").val(editors.html.getCode()),n.find("input[name=method]").val(t),n.find("input[name=checksum]").val(s.state.checksum),n}function w(a,o,r){var c=b(a);s.panels.save(),s.panels.saveOnExit=!0;var l=c.serializeArray().reduce(function(e,t){return e[t.name]=t.value,e},{});s.settings.useCompression&&g("html,css,javascript",l),o?e.ajax({url:s.getURL({withRevision:!0})+"/save",data:l,dataType:"json",type:"post",headers:{Accept:"application/json"},success:function(e){if(r&&r(e),t.sessionStorage.setItem("checksum",e.checksum),m=e.checksum,s.state.checksum=m,s.state.code=e.code,s.state.revision=e.revision,s.state.latest=!0,s.state.metadata={name:s.user.name},c.attr("action",s.getURL({withRevision:!0})+"/save"),window.history&&window.history.pushState){var a=n.getHighlightLines();a&&(a="#"+a);var i=n.getQuery();i&&(i="?"+i),window.history.pushState(null,"",s.getURL({withRevision:!d})+"/edit"+i+a),t.sessionStorage.setItem("url",s.getURL({withRevision:!d}))}else window.location.hash=e.edit;s.$document.trigger("saved")},error:function(e){h(e,null)},complete:function(){i.inprogress(!1)}}):c.submit()}e("a.clone").click(y),e("#tip").delegate("a.clone","click",y)});
//# sourceMappingURL=../sourcemaps/chrome/save.js.map
