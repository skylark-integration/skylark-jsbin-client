{"version":3,"sources":["chrome/infocard.js"],"names":["define","$","jsbin","analytics","global","setupInfocard","embed","$template","$header","find","canvas","s","spinner","htmlpanel","panels","named","html","viewers","es","re","head","meta","title","length","on","insertTag","getCode","value","this","updateCode","replace","all","capture","state","updateSettings","description","updateHeaders","headers","each","val","trim","add","e","toTrigger","infocardVisible","hideOpen","preventDefault","infocard","toggleClass","index","klass","indexOf","trigger","one","statusCode","data","getJSON","static","codes","forEach","code","string","$headers","event","$fields","$clones","clone","before","eq","focus","closest","initHandlers","updateInfoCard","$document","bind","updateStats","_data","JSON","parse","connections","addClass","$b","removeClass","c","setTimeout","listenStats","owner","window","EventSource","close","getURL","checksum","addEventListener","throttle","tag","editor","userhtml","type","text","processor","processors","getPanelText","test","setCode","result","cursor","cm","selected","somethingSelected","visible","listSelections","getCursor","mobile","setCursor","setSelections","metadata","classes","name","attr","avatar","push","user","stop","streaming","start","prettyDate","last_updated","pro","visibility","join","parent","removeAttr","hiddenProperty","document","visibilityChangeEvent","handleVisibility","url","newurl","location","toString","saveDisabled","pathname","slice","getScript","version"],"mappings":"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","file":"../../chrome/infocard.js","sourcesContent":["define([\r\n  \"skylark-jquery\",\r\n   \"../jsbin\",\r\n   \"./analytics\"\r\n],function ($,jsbin,analytics) {\r\n  if ('EventSource' in global) {\r\n    return setupInfocard()\r\n  } else {\r\n    $.getScript(jsbin['static'] + '/js/vendor/eventsource.js', setupInfocard);\r\n  }\r\n  function setupInfocard() {\r\n    /*global spinner, $, jsbin, prettyDate, EventSource, throttle, $document, analytics, throttle*/\r\n    'use strict';\r\n\r\n    // don't insert this on embeded views\r\n    if (jsbin.embed) {\r\n      return;\r\n    }\r\n\r\n    var $template = $('#infocard'); // donkey way of cloning from template\r\n    var $header = $template.find('header');\r\n    var canvas = $header.find('canvas')[0];\r\n    var s = spinner(canvas);\r\n    var htmlpanel = jsbin.panels.named.html;\r\n    var viewers = 0;\r\n    var es = null;\r\n\r\n    var re = {\r\n      head: /<head(.*)\\n/i,\r\n      meta: /(<meta name=\"description\" content=\")([^\"]*)/im,\r\n      title: /<title>(.*)<\\/title>/im\r\n    };\r\n\r\n    if ($template.length === 0) {\r\n      return;\r\n    }\r\n\r\n\r\n\r\n    function updateStats(event, _data) {\r\n      var data = _data ? JSON.parse(_data) : JSON.parse(event.data);\r\n\r\n      if (data.connections > 0 && viewers === 0) {\r\n        $template.addClass('viewers');\r\n      }\r\n\r\n      if (viewers !== data.connections) {\r\n        var $b = $header.find('.viewers b').removeClass('up down').html('<b>' + data.connections + '<br>' + viewers + '<br>' + data.connections + '</b>'),\r\n            c = viewers > data.connections ? 'down' : 'up';\r\n        setTimeout(function () {\r\n          $b.addClass(c);\r\n        }, 0);\r\n      }\r\n\r\n      viewers = data.connections;\r\n\r\n      if (viewers === 0) {\r\n        setTimeout(function () {\r\n          $template.removeClass('viewers');\r\n        }, 250);\r\n      }\r\n\r\n    }\r\n\r\n    function listenStats(owner) {\r\n      if (window.EventSource && owner) {\r\n        // TODO use pagevisibility api to close connection\r\n        if (es) {\r\n          es.close();\r\n        }\r\n        es = new EventSource(jsbin.getURL() + '/stats?checksum=' + jsbin.state.checksum);\r\n        es.addEventListener('stats', jsbin.throttle(updateStats, 1000));\r\n      }\r\n    }\r\n\r\n    function insertTag(tag) {\r\n      var cm = htmlpanel.editor;\r\n      var html = htmlpanel.getCode();\r\n\r\n      if (tag === 'meta') {\r\n        tag = 'meta name=\"description';\r\n      }\r\n\r\n\r\n      if (html.indexOf('<' + tag) === -1) {\r\n        var userhtml = getPanelText(tag === 'title' ? 'title' : 'description', '');\r\n        if (re.head.test(html)) {\r\n          html = html.replace(re.head, '<head$1\\n' + userhtml);\r\n        } else {\r\n          // slap in the top\r\n          html = userhtml + html;\r\n        }\r\n        htmlpanel.setCode(html);\r\n      }\r\n    }\r\n\r\n    function getPanelText(type, text) {\r\n      var processor = jsbin.state.processors.html;\r\n\r\n      text = text.replace(/\"/g, '&quot;');\r\n\r\n      if (type === 'title') {\r\n        if (processor === 'jade') {\r\n          return 'title ' + text + '\\n';\r\n        }\r\n\r\n        return '<title>' + text + '</title>\\n';\r\n      }\r\n\r\n      if (type === 'description') {\r\n        if (processor === 'jade') {\r\n          return 'meta(name=\"description\", content=\"' + text + '\")\\n';\r\n        }\r\n\r\n        return '<meta name=\"description\" content=\"' + text + '\">\\n';\r\n      }\r\n\r\n      return text;\r\n    }\r\n\r\n\r\n    if ($template.find('.settings')) {\r\n      $template.find('#title').on('input', function () {\r\n        insertTag('title');\r\n        var html = htmlpanel.getCode();\r\n        var value = this.value;\r\n        var result = html.replace(re.title, function (all, capture) {\r\n          return '<title>' + value.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</title>';\r\n        });\r\n        updateCode(result);\r\n        jsbin.state.updateSettings({ title: this.value });\r\n      });\r\n\r\n      $template.find('#description').on('input', function () {\r\n        insertTag('meta');\r\n        var html = htmlpanel.getCode();\r\n        var value = this.value;\r\n        var result = html.replace(re.meta, function (all, capture) {\r\n          return capture + value.replace(/\"/g, '&quot;');\r\n        });\r\n        updateCode(result);\r\n        jsbin.state.updateSettings({ description: this.value });\r\n      });\r\n    }\r\n\r\n    function updateCode(result) {\r\n      // capture selection and cursor\r\n      var state = null;\r\n      var cursor = null;\r\n      var cm = htmlpanel.editor;\r\n      var selected = cm.somethingSelected();\r\n      if (jsbin.panels.named.html.visible) {\r\n        if (selected) {\r\n          state = cm.listSelections();\r\n        }\r\n        cursor = cm.getCursor();\r\n      }\r\n\r\n      htmlpanel.setCode(result);\r\n\r\n      // then restore\r\n      if (jsbin.panels.named.html.visible) {\r\n        if (!jsbin.mobile) cm.setCursor(cursor);\r\n        if (selected) {\r\n          cm.setSelections(state);\r\n        }\r\n      }\r\n    }\r\n\r\n    function updateInfoCard(event) {\r\n      var meta = jsbin.state.metadata || {};\r\n      var classes = [];\r\n      var owner = false;\r\n\r\n      if (meta.name) {\r\n        $header.find('.name b').html(meta.name);\r\n        $header.find('img').attr('src', meta.avatar);\r\n        classes.push(meta.name);\r\n      }\r\n\r\n      if (jsbin.state.checksum || (jsbin.user && (meta.name === jsbin.user.name))) {\r\n        owner = true;\r\n        classes.push('author');\r\n      }\r\n\r\n      if (s) {\r\n        s.stop();\r\n      }\r\n\r\n      if (!jsbin.state.streaming || owner === true) {\r\n        $header.find('time').html(event ? 'just now' : prettyDate(meta.last_updated));\r\n      } else if (owner === false) {\r\n        $header.find('time').html('Streaming');\r\n        classes.push('streaming');\r\n        if (s) {\r\n          s.start();\r\n        }\r\n      }\r\n\r\n      if (!jsbin.checksum) {\r\n        classes.push('meta');\r\n      }\r\n\r\n      if (meta.pro) {\r\n        classes.push('pro');\r\n      }\r\n\r\n      $header.find('.visibility').text(meta.visibility);\r\n\r\n      if (meta.visibility === 'private') {\r\n        classes.push('private');\r\n      } else if (meta.visibility === 'public') {\r\n        classes.push('public');\r\n      } // TODO handle team\r\n\r\n      if (jsbin.state.code) {\r\n        $template.addClass(classes.join(' ')).parent().removeAttr('hidden');\r\n      }\r\n\r\n      if (jsbin.state.streaming) {\r\n        if (window.EventSource && owner) {\r\n          listenStats(owner);\r\n          handleVisibility(owner);\r\n          var url = jsbin.getURL();\r\n          jsbin.$document.on('saved', function () {\r\n            var newurl = window.location.toString();\r\n            if (url !== newurl) {\r\n              es.close();\r\n              listenStats(owner);\r\n            }\r\n          });\r\n        } else if (jsbin.saveDisabled === true && window.location.pathname.slice(-5) === '/edit') {\r\n          $.getScript(jsbin.static + '/js/spike.js?' + jsbin.version);\r\n          jsbin.$document.on('stats', jsbin.throttle(updateStats, 1000));\r\n        }\r\n      }\r\n    }\r\n\r\n    function handleVisibility(owner) {\r\n      var hiddenProperty = 'hidden' in document ? 'hidden' :\r\n        'webkitHidden' in document ? 'webkitHidden' :\r\n        'mozHidden' in document ? 'mozHidden' :\r\n        null;\r\n      var visibilityStateProperty = 'visibilityState' in document ? 'visibilityState' :\r\n        'webkitVisibilityState' in document ? 'webkitVisibilityState' :\r\n        'mozVisibilityState' in document ? 'mozVisibilityState' :\r\n        null;\r\n\r\n      if (visibilityStateProperty) {\r\n        var visibilityChangeEvent = hiddenProperty.replace(/hidden/i, 'visibilitychange');\r\n        document.addEventListener(visibilityChangeEvent, function visibilityChangeEvent() {\r\n          if (document[hiddenProperty]) { // hidden\r\n            es.close();\r\n          } else {\r\n            listenStats(owner);\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    function initHandlers() {\r\n      $('a.more').add($header).on('mousedown touchstart', function (e) {\r\n        infocardVisible = !infocardVisible; // this is hack :-\\\r\n        hideOpen();\r\n        e.preventDefault();\r\n        analytics.infocard('click', 'no-result');\r\n        var toTrigger;\r\n        $template.toggleClass(function (index, klass) {\r\n          toTrigger = klass.indexOf('open') === -1 ? 'open' : 'close';\r\n          infocardVisible = toTrigger === 'open';\r\n          return 'open';\r\n        }).trigger(toTrigger);\r\n      });\r\n\r\n      $template.one('open', function () {\r\n        var statusCode = $('#status').data('status') || 200;\r\n        $.getJSON(jsbin.static + '/js/http-codes.json', function (codes) {\r\n          var html = '';\r\n          codes.forEach(function (code) {\r\n            html += '<option value=\"' + code.code + '\">' + code.string + '</option>';\r\n          });\r\n          $('#status').html(html).val(statusCode).on('change', function () {\r\n            jsbin.state.updateSettings({ statusCode: this.value });\r\n          });\r\n        });\r\n      }).on('close', function () {\r\n\r\n      });\r\n\r\n      function updateHeaders() {\r\n        // grab all the headers with values and send that instead\r\n        var headers = {};\r\n        $template.find('.row').each(function () {\r\n          if ($(this).find('[name=\"header-value\"]').val().trim()) {\r\n            headers[$(this).find('input:first').val()] = $(this).find('input:last').val();\r\n          }\r\n        });\r\n\r\n        jsbin.state.updateSettings({ headers: headers }, 'PUT');\r\n      }\r\n\r\n      var $headers = $template.find('#headers');\r\n      $template.on('click', '#headers button', function (event) {\r\n        event.preventDefault();\r\n        var $fields = $headers.find('span:last');\r\n        updateHeaders();\r\n\r\n        var $clones = $fields.clone(true);\r\n        $fields.before($clones);\r\n        $fields.find('input').val('').eq(0).focus();\r\n      });\r\n\r\n      $template.on('input', '.row input', function () {\r\n        updateHeaders($(this).closest('.row'));\r\n      });\r\n    }\r\n\r\n    initHandlers();\r\n    updateInfoCard();\r\n    $document.bind('saved', updateInfoCard);\r\n  }\r\n});\r\n"]}