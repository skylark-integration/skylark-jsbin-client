{"version":3,"sources":["chrome/infocard.js"],"names":["define","$","jsbin","global","setupInfocard","embed","$template","$header","find","canvas","s","spinner","htmlpanel","panels","html","viewers","es","re","head","meta","title","length","on","insertTag","getCode","value","this","updateCode","replace","all","capture","state","updateSettings","description","updateHeaders","headers","each","val","trim","add","e","toTrigger","infocardVisible","hideOpen","preventDefault","analytics","infocard","toggleClass","index","klass","indexOf","trigger","one","statusCode","data","getJSON","static","codes","forEach","code","string","$headers","event","$fields","$clones","clone","before","eq","focus","closest","initHandlers","updateInfoCard","$document","bind","updateStats","_data","JSON","parse","connections","addClass","$b","removeClass","c","setTimeout","listenStats","owner","window","EventSource","close","getURL","checksum","addEventListener","throttle","tag","editor","userhtml","type","text","processor","processors","getPanelText","test","setCode","result","cursor","cm","selected","somethingSelected","visible","listSelections","getCursor","mobile","setCursor","setSelections","metadata","classes","name","attr","avatar","push","user","stop","streaming","start","prettyDate","last_updated","pro","visibility","join","parent","removeAttr","hiddenProperty","document","visibilityChangeEvent","handleVisibility","url","newurl","location","toString","saveDisabled","pathname","slice","getScript","version"],"mappings":"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","file":"../../chrome/infocard.js","sourcesContent":["define([\r\n  \"skylark-jquery\",\r\n   \"../jsbin\"\r\n],function ($,jsbin) {\r\n  if ('EventSource' in global) {\r\n    return setupInfocard()\r\n  } else {\r\n    $.getScript(jsbin['static'] + '/js/vendor/eventsource.js', setupInfocard);\r\n  }\r\n  function setupInfocard() {\r\n    /*global spinner, $, jsbin, prettyDate, EventSource, throttle, $document, analytics, throttle*/\r\n    'use strict';\r\n\r\n    // don't insert this on embeded views\r\n    if (jsbin.embed) {\r\n      return;\r\n    }\r\n\r\n    var $template = $('#infocard'); // donkey way of cloning from template\r\n    var $header = $template.find('header');\r\n    var canvas = $header.find('canvas')[0];\r\n    var s = spinner(canvas);\r\n    var htmlpanel = jsbin.panels.panels.html;\r\n    var viewers = 0;\r\n    var es = null;\r\n\r\n    var re = {\r\n      head: /<head(.*)\\n/i,\r\n      meta: /(<meta name=\"description\" content=\")([^\"]*)/im,\r\n      title: /<title>(.*)<\\/title>/im\r\n    };\r\n\r\n    if ($template.length === 0) {\r\n      return;\r\n    }\r\n\r\n\r\n\r\n    function updateStats(event, _data) {\r\n      var data = _data ? JSON.parse(_data) : JSON.parse(event.data);\r\n\r\n      if (data.connections > 0 && viewers === 0) {\r\n        $template.addClass('viewers');\r\n      }\r\n\r\n      if (viewers !== data.connections) {\r\n        var $b = $header.find('.viewers b').removeClass('up down').html('<b>' + data.connections + '<br>' + viewers + '<br>' + data.connections + '</b>'),\r\n            c = viewers > data.connections ? 'down' : 'up';\r\n        setTimeout(function () {\r\n          $b.addClass(c);\r\n        }, 0);\r\n      }\r\n\r\n      viewers = data.connections;\r\n\r\n      if (viewers === 0) {\r\n        setTimeout(function () {\r\n          $template.removeClass('viewers');\r\n        }, 250);\r\n      }\r\n\r\n    }\r\n\r\n    function listenStats(owner) {\r\n      if (window.EventSource && owner) {\r\n        // TODO use pagevisibility api to close connection\r\n        if (es) {\r\n          es.close();\r\n        }\r\n        es = new EventSource(jsbin.getURL() + '/stats?checksum=' + jsbin.state.checksum);\r\n        es.addEventListener('stats', throttle(updateStats, 1000));\r\n      }\r\n    }\r\n\r\n    function insertTag(tag) {\r\n      var cm = htmlpanel.editor;\r\n      var html = htmlpanel.getCode();\r\n\r\n      if (tag === 'meta') {\r\n        tag = 'meta name=\"description';\r\n      }\r\n\r\n\r\n      if (html.indexOf('<' + tag) === -1) {\r\n        var userhtml = getPanelText(tag === 'title' ? 'title' : 'description', '');\r\n        if (re.head.test(html)) {\r\n          html = html.replace(re.head, '<head$1\\n' + userhtml);\r\n        } else {\r\n          // slap in the top\r\n          html = userhtml + html;\r\n        }\r\n        htmlpanel.setCode(html);\r\n      }\r\n    }\r\n\r\n    function getPanelText(type, text) {\r\n      var processor = jsbin.state.processors.html;\r\n\r\n      text = text.replace(/\"/g, '&quot;');\r\n\r\n      if (type === 'title') {\r\n        if (processor === 'jade') {\r\n          return 'title ' + text + '\\n';\r\n        }\r\n\r\n        return '<title>' + text + '</title>\\n';\r\n      }\r\n\r\n      if (type === 'description') {\r\n        if (processor === 'jade') {\r\n          return 'meta(name=\"description\", content=\"' + text + '\")\\n';\r\n        }\r\n\r\n        return '<meta name=\"description\" content=\"' + text + '\">\\n';\r\n      }\r\n\r\n      return text;\r\n    }\r\n\r\n\r\n    if ($template.find('.settings')) {\r\n      $template.find('#title').on('input', function () {\r\n        insertTag('title');\r\n        var html = htmlpanel.getCode();\r\n        var value = this.value;\r\n        var result = html.replace(re.title, function (all, capture) {\r\n          return '<title>' + value.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</title>';\r\n        });\r\n        updateCode(result);\r\n        jsbin.state.updateSettings({ title: this.value });\r\n      });\r\n\r\n      $template.find('#description').on('input', function () {\r\n        insertTag('meta');\r\n        var html = htmlpanel.getCode();\r\n        var value = this.value;\r\n        var result = html.replace(re.meta, function (all, capture) {\r\n          return capture + value.replace(/\"/g, '&quot;');\r\n        });\r\n        updateCode(result);\r\n        jsbin.state.updateSettings({ description: this.value });\r\n      });\r\n    }\r\n\r\n    function updateCode(result) {\r\n      // capture selection and cursor\r\n      var state = null;\r\n      var cursor = null;\r\n      var cm = htmlpanel.editor;\r\n      var selected = cm.somethingSelected();\r\n      if (jsbin.panels.panels.html.visible) {\r\n        if (selected) {\r\n          state = cm.listSelections();\r\n        }\r\n        cursor = cm.getCursor();\r\n      }\r\n\r\n      htmlpanel.setCode(result);\r\n\r\n      // then restore\r\n      if (jsbin.panels.panels.html.visible) {\r\n        if (!jsbin.mobile) cm.setCursor(cursor);\r\n        if (selected) {\r\n          cm.setSelections(state);\r\n        }\r\n      }\r\n    }\r\n\r\n    function updateInfoCard(event) {\r\n      var meta = jsbin.state.metadata || {};\r\n      var classes = [];\r\n      var owner = false;\r\n\r\n      if (meta.name) {\r\n        $header.find('.name b').html(meta.name);\r\n        $header.find('img').attr('src', meta.avatar);\r\n        classes.push(meta.name);\r\n      }\r\n\r\n      if (jsbin.state.checksum || (jsbin.user && (meta.name === jsbin.user.name))) {\r\n        owner = true;\r\n        classes.push('author');\r\n      }\r\n\r\n      if (s) {\r\n        s.stop();\r\n      }\r\n\r\n      if (!jsbin.state.streaming || owner === true) {\r\n        $header.find('time').html(event ? 'just now' : prettyDate(meta.last_updated));\r\n      } else if (owner === false) {\r\n        $header.find('time').html('Streaming');\r\n        classes.push('streaming');\r\n        if (s) {\r\n          s.start();\r\n        }\r\n      }\r\n\r\n      if (!jsbin.checksum) {\r\n        classes.push('meta');\r\n      }\r\n\r\n      if (meta.pro) {\r\n        classes.push('pro');\r\n      }\r\n\r\n      $header.find('.visibility').text(meta.visibility);\r\n\r\n      if (meta.visibility === 'private') {\r\n        classes.push('private');\r\n      } else if (meta.visibility === 'public') {\r\n        classes.push('public');\r\n      } // TODO handle team\r\n\r\n      if (jsbin.state.code) {\r\n        $template.addClass(classes.join(' ')).parent().removeAttr('hidden');\r\n      }\r\n\r\n      if (jsbin.state.streaming) {\r\n        if (window.EventSource && owner) {\r\n          listenStats(owner);\r\n          handleVisibility(owner);\r\n          var url = jsbin.getURL();\r\n          $document.on('saved', function () {\r\n            var newurl = window.location.toString();\r\n            if (url !== newurl) {\r\n              es.close();\r\n              listenStats(owner);\r\n            }\r\n          });\r\n        } else if (jsbin.saveDisabled === true && window.location.pathname.slice(-5) === '/edit') {\r\n          $.getScript(jsbin.static + '/js/spike.js?' + jsbin.version);\r\n          $document.on('stats', throttle(updateStats, 1000));\r\n        }\r\n      }\r\n    }\r\n\r\n    function handleVisibility(owner) {\r\n      var hiddenProperty = 'hidden' in document ? 'hidden' :\r\n        'webkitHidden' in document ? 'webkitHidden' :\r\n        'mozHidden' in document ? 'mozHidden' :\r\n        null;\r\n      var visibilityStateProperty = 'visibilityState' in document ? 'visibilityState' :\r\n        'webkitVisibilityState' in document ? 'webkitVisibilityState' :\r\n        'mozVisibilityState' in document ? 'mozVisibilityState' :\r\n        null;\r\n\r\n      if (visibilityStateProperty) {\r\n        var visibilityChangeEvent = hiddenProperty.replace(/hidden/i, 'visibilitychange');\r\n        document.addEventListener(visibilityChangeEvent, function visibilityChangeEvent() {\r\n          if (document[hiddenProperty]) { // hidden\r\n            es.close();\r\n          } else {\r\n            listenStats(owner);\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    function initHandlers() {\r\n      $('a.more').add($header).on('mousedown touchstart', function (e) {\r\n        infocardVisible = !infocardVisible; // this is hack :-\\\r\n        hideOpen();\r\n        e.preventDefault();\r\n        analytics.infocard('click', 'no-result');\r\n        var toTrigger;\r\n        $template.toggleClass(function (index, klass) {\r\n          toTrigger = klass.indexOf('open') === -1 ? 'open' : 'close';\r\n          infocardVisible = toTrigger === 'open';\r\n          return 'open';\r\n        }).trigger(toTrigger);\r\n      });\r\n\r\n      $template.one('open', function () {\r\n        var statusCode = $('#status').data('status') || 200;\r\n        $.getJSON(jsbin.static + '/js/http-codes.json', function (codes) {\r\n          var html = '';\r\n          codes.forEach(function (code) {\r\n            html += '<option value=\"' + code.code + '\">' + code.string + '</option>';\r\n          });\r\n          $('#status').html(html).val(statusCode).on('change', function () {\r\n            jsbin.state.updateSettings({ statusCode: this.value });\r\n          });\r\n        });\r\n      }).on('close', function () {\r\n\r\n      });\r\n\r\n      function updateHeaders() {\r\n        // grab all the headers with values and send that instead\r\n        var headers = {};\r\n        $template.find('.row').each(function () {\r\n          if ($(this).find('[name=\"header-value\"]').val().trim()) {\r\n            headers[$(this).find('input:first').val()] = $(this).find('input:last').val();\r\n          }\r\n        });\r\n\r\n        jsbin.state.updateSettings({ headers: headers }, 'PUT');\r\n      }\r\n\r\n      var $headers = $template.find('#headers');\r\n      $template.on('click', '#headers button', function (event) {\r\n        event.preventDefault();\r\n        var $fields = $headers.find('span:last');\r\n        updateHeaders();\r\n\r\n        var $clones = $fields.clone(true);\r\n        $fields.before($clones);\r\n        $fields.find('input').val('').eq(0).focus();\r\n      });\r\n\r\n      $template.on('input', '.row input', function () {\r\n        updateHeaders($(this).closest('.row'));\r\n      });\r\n    }\r\n\r\n    initHandlers();\r\n    updateInfoCard();\r\n    $document.bind('saved', updateInfoCard);\r\n  }\r\n});\r\n"]}