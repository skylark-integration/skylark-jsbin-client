{"version":3,"sources":["chrome/save.js"],"names":["define","$","store","panels","jsbin","analytics","saving","todo","html","css","javascript","_inprogress","inprogress","save","pop","updateCode","getTagContent","tag","named","getCode","result","indexOf","console","error","replace","re","all","capture1","capture2","meta","title","click","event","preventDefault","milestone","ajax","saveDisabled","state","changed","mobile","owner","saveCode","$shareLinks","$panelCheckboxes","split","length","updateSavedState","mapping","live","query","filter","map","this","getAttribute","get","join","each","path","url","getURL","withRevision","id","nodeName","hash","getHighlightLines","href","value","documentTitle","static","m","<",">","\"","&","bind","on","checksum","saveChecksum","lastHTML","updateDocMeta","data","panelId","currentHTML","description","updateSettings","document","name","$document","prop","closest","removeClass","attr","sessionStorage","getItem","onSaveError","jqXHR","status","documentElement","addClass","trigger","type","content","window","location","savingLabels","text","animate","opacity","_console","message","unbind","one","shown","embed","sandbox","onload","origin","ismac","navigator","userAgent","cmd","shift","plus","root","append","allEditors","panel","stop","throttle","delay","deleted","savecontent","code","compressKeys","keys","obj","compressed","forEach","key","LZString","compressToUTF16","callback","panelSettings","processors","revision","method","settings","JSON","stringify","useCompression","protocol","cache","processed","dataType","headers","Accept","success","latest","complete","clone","setupform","submit","$form","empty","token","find","val","editors","ajaxCallback","saveOnExit","serializeArray","reduce","setItem","metadata","user","history","pushState","getQuery","edit","delegate"],"mappings":"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","file":"../../chrome/save.js","sourcesContent":["define([\r\n  \"skylark-jquery\",\r\n  \"skylark-jsbin-base/storage\",\r\n  \"skylark-jsbin-coder/editors/panels\",\r\n   \"../jsbin\",\r\n   \"./analytics\"\r\n],function ($,store,panels,jsbin,analytics) {\r\n  /*jshint strict: false */\r\n  /*globals $, analytics, jsbin, documentTitle, $document, throttle, editors*/\r\n  var saving = {\r\n    todo: {\r\n      html: false,\r\n      css: false,\r\n      javascript: false\r\n    },\r\n    _inprogress: false,\r\n    inprogress: function (inprogress) {\r\n      if (typeof inprogress === 'undefined') {\r\n        return saving._inprogress;\r\n      }\r\n\r\n      saving._inprogress = inprogress;\r\n      if (inprogress === false) {\r\n        var panels = ['html','css','javascript'];\r\n\r\n        var save = function () {\r\n          var todo = panels.pop();\r\n          if (todo && saving.todo[todo]) {\r\n            saving._inprogress = true;\r\n            updateCode(todo, save);\r\n            saving.todo[todo] = false;\r\n          } else if (todo) {\r\n            save();\r\n          }\r\n        };\r\n\r\n        save();\r\n      }\r\n    }\r\n  };\r\n\r\n  function getTagContent(tag) {\r\n    var html = jsbin.panels.named.html.getCode();\r\n    var result = '';\r\n\r\n    // if we don't have the tag, bail with an empty string\r\n    if (html.indexOf('<' + tag) === -1) {\r\n      return result;\r\n    }\r\n\r\n    if (tag !== 'title' && tag !== 'meta') {\r\n      console.error('getTagContent for ' + tag + ' is not supported');\r\n      return result;\r\n    }\r\n\r\n    // grab the content based on the earlier defined regexp\r\n    html.replace(getTagContent.re[tag], function (all, capture1, capture2) {\r\n      result = tag === 'title' ? capture1 : capture2;\r\n    });\r\n\r\n    return result;\r\n  }\r\n\r\n  getTagContent.re = {\r\n    meta: /(<meta name=\"description\" content=\")([^\"]*)/im,\r\n    title: /<title>(.*)<\\/title>/im\r\n  };\r\n\r\n\r\n  // to allow for download button to be introduced via beta feature\r\n  $('a.save').click(function (event) {\r\n    event.preventDefault();\r\n\r\n    analytics.milestone();\r\n    // if save is disabled, hitting save will trigger a reload\r\n    var ajax = true;\r\n    if (jsbin.saveDisabled === true) {\r\n      ajax = false;\r\n    }\r\n\r\n    if ((jsbin.state.changed || jsbin.mobile) || !jsbin.owner()) {\r\n      saveCode('save', ajax);\r\n    }\r\n\r\n    return false;\r\n  });\r\n\r\n  var $shareLinks = $('#share .link');\r\n  var $panelCheckboxes = $('#sharemenu #sharepanels input');\r\n\r\n  // TODO remove split when live\r\n  var split = $('#sharemenu .share-split').length;\r\n\r\n  // TODO candidate for removal\r\n  function updateSavedState() {\r\n    'use strict';\r\n    if (split) {\r\n      return;\r\n    }\r\n\r\n    var mapping = {\r\n      live: 'output',\r\n      javascript: 'js',\r\n      css: 'css',\r\n      html: 'html',\r\n      console: 'console'\r\n    };\r\n\r\n    var withRevision = true;\r\n\r\n    var query = $panelCheckboxes.filter(':checked').map(function () {\r\n      return mapping[this.getAttribute('data-panel')];\r\n    }).get().join(',');\r\n    $shareLinks.each(function () {\r\n      var path = this.getAttribute('data-path');\r\n      var url = jsbin.getURL({ withRevision: withRevision }) + path + (query && this.id !== 'livepreview' ? '?' + query : ''),\r\n          nodeName = this.nodeName;\r\n      var hash = panels.getHighlightLines();\r\n\r\n      if (hash) {\r\n        hash = '#' + hash;\r\n      }\r\n\r\n      if (nodeName === 'A') {\r\n        this.href = url;\r\n      } else if (nodeName === 'INPUT') {\r\n        this.value = url;\r\n        if (path === '/edit') {\r\n          this.value += hash;\r\n        }\r\n      } else if (nodeName === 'TEXTAREA') {\r\n        this.value = ('<a class=\"jsbin-embed\" href=\"' + url + hash + '\">' + jsbin.documentTitle + '</a><' + 'script src=\"' + jsbin.static + '/js/embed.js\"><' + '/script>').replace(/<>\"&/g, function (m) {\r\n            return {\r\n              '<': '&lt;',\r\n              '>': '&gt;',\r\n              '\"': '&quot;',\r\n              '&': '&amp;'\r\n            }[m];\r\n          });\r\n      }\r\n    });\r\n  }\r\n\r\n  $('#sharemenu').bind('open', updateSavedState);\r\n  $('#sharebintype input[type=radio]').on('click', function () {\r\n    if (this.value === 'snapshot') {\r\n      jsbin.state.checksum = false;\r\n      saveChecksum = false;\r\n    }\r\n    updateSavedState();\r\n  });\r\n\r\n  var lastHTML = null;\r\n\r\n  function updateDocMeta(event, data) {\r\n    if (data) {\r\n      if (data.panelId !== 'html') {\r\n        return; // ignore non-html updates\r\n      }\r\n    }\r\n\r\n    var currentHTML = jsbin.panels.named.html.getCode();\r\n    if (lastHTML !== currentHTML) {\r\n      lastHTML = currentHTML;\r\n\r\n      var description = getTagContent('meta');\r\n      if (description !== jsbin.state.description) {\r\n        jsbin.state.description = description;\r\n        jsbin.state.updateSettings({ description: description });\r\n      }\r\n\r\n      var title = getTagContent('title');\r\n      if (title !== jsbin.state.title) {\r\n        jsbin.state.title = title;\r\n        jsbin.state.updateSettings({ title: title });\r\n\r\n        jsbin.documentTitle = title;\r\n        if (jsbin.documentTitle) {\r\n          document.title = jsbin.documentTitle + ' - ' + jsbin.name;\r\n        } else {\r\n          document.title = jsbin.name;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  jsbin.$document.on('saveComplete', updateDocMeta); // update, not create\r\n\r\n  jsbin.$document.on('saved', function () {\r\n    jsbin.state.changed = false;\r\n    updateSavedState();\r\n\r\n    $('#sharebintype input[type=radio][value=\"realtime\"]').prop('checked', true);\r\n\r\n    $shareLinks.closest('.menu').removeClass('hidden');\r\n\r\n    $('#jsbinurl').attr('href', jsbin.getURL()).removeClass('hidden');\r\n    $('#clone').removeClass('hidden');\r\n\r\n    updateDocMeta();\r\n  });\r\n\r\n  var saveChecksum = jsbin.state.checksum || store.sessionStorage.getItem('checksum') || false;\r\n\r\n  // store it back on state\r\n  jsbin.state.checksum = saveChecksum;\r\n\r\n  if (saveChecksum) {\r\n    // remove the disabled class, but also remove the cancelling event handlers\r\n    $('#share div.disabled').removeClass('disabled').unbind('click mousedown mouseup');\r\n  } else {\r\n    $('#share div.disabled').one('click', function (event) {\r\n      event.preventDefault();\r\n      $('a.save').click();\r\n    });\r\n  }\r\n\r\n  jsbin.$document.one('saved', function () {\r\n    $('#share div.disabled').removeClass('disabled').unbind('click mousedown mouseup');\r\n  });\r\n\r\n  function onSaveError(jqXHR, panelId) {\r\n    if (jqXHR.status === 413) {\r\n      // Hijack the tip label to show an error message.\r\n      $('#tip p').html('Sorry this bin is too large for us to save');\r\n      $(document.documentElement).addClass('showtip');\r\n    } else if (jqXHR.status === 403) {\r\n      jsbin.$document.trigger('tip', {\r\n        type: 'error',\r\n        content: 'I think there\\'s something wrong with your session and I\\'m unable to save. <a href=\"' + window.location + '\"><strong>Refresh to fix this</strong></a>, you <strong>will not</strong> lose your code.'\r\n      });\r\n    } else if (panelId) {\r\n      if (panelId) { savingLabels[panelId].text('Saving...').animate({ opacity: 1 }, 100); }\r\n      window._console.error({message: 'Warning: Something went wrong while saving. Your most recent work is not saved.'});\r\n    }\r\n  }\r\n\r\n\r\n\r\n  // only start live saving it they're allowed to (whereas save is disabled if they're following)\r\n  if (!jsbin.saveDisabled) {\r\n    $('.code.panel .label .name').append('<span class=\"saved\">Saved</span>');\r\n\r\n    var savingLabels = {\r\n      html: $('.panel.html .name span.saved'),\r\n      javascript: $('.panel.javascript .name span.saved'),\r\n      css: $('.panel.css .name span.saved'),\r\n    };\r\n\r\n    jsbin.$document.bind('jsbinReady', function () {\r\n      jsbin.state.changed = false;\r\n      jsbin.panels.allEditors(function (panel) {\r\n        panel.on('processor', function () {\r\n          // if the url doesn't match the root - i.e. they've actually saved something then save on processor change\r\n          if (jsbin.root !== jsbin.getURL()) {\r\n            jsbin.$document.trigger('codeChange', [{ panelId: panel.id }]);\r\n          }\r\n        });\r\n      });\r\n\r\n      jsbin.$document.bind('codeChange', function (event, data) {\r\n        jsbin.state.changed = true;\r\n        // savingLabels[data.panelId].text('Saving');\r\n        if (savingLabels[data.panelId]) {\r\n          savingLabels[data.panelId].css({ 'opacity': 0 }).stop(true, true);\r\n        }\r\n      });\r\n\r\n      jsbin.$document.bind('saveComplete', jsbin.throttle(function (event, data) {\r\n        // show saved, then revert out animation\r\n        savingLabels[data.panelId]\r\n          .text('Saved')\r\n          .stop(true, true)\r\n          .animate({ opacity: 1 }, 100)\r\n          .delay(1200)\r\n          .animate({ opacity: 0 }, 500);\r\n      }, 500));\r\n\r\n      jsbin.$document.bind('codeChange', jsbin.throttle(function (event, data) {\r\n        if (!data.panelId) {\r\n          return;\r\n        }\r\n\r\n        if (jsbin.state.deleted) {\r\n          return;\r\n        }\r\n\r\n        var panelId = data.panelId;\r\n\r\n        jsbin.panels.savecontent();\r\n\r\n        if (saving.inprogress()) {\r\n          // queue up the request and wait\r\n          saving.todo[panelId] = true;\r\n          return;\r\n        }\r\n\r\n        saving.inprogress(true);\r\n\r\n        // We force a full save if there's no checksum OR if there's no bin code/url\r\n        if (!saveChecksum || !jsbin.state.code) {\r\n          // create the bin and when the response comes back update the url\r\n          saveCode('save', true);\r\n        } else {\r\n          updateCode(panelId);\r\n        }\r\n      }, 30 * 1000));\r\n    });\r\n  } else {\r\n    jsbin.$document.one('jsbinReady', function () {\r\n      'use strict';\r\n      var shown = false;\r\n      if (!jsbin.embed && !jsbin.sandbox) {\r\n        jsbin.$document.on('codeChange.live', function (event, data) {\r\n          if (!data.onload && !shown && data.origin !== 'setValue') {\r\n            shown = true;\r\n            var ismac = navigator.userAgent.indexOf(' Mac ') !== -1;\r\n            var cmd = ismac ? '⌘' : 'ctrl';\r\n            var shift = ismac ? '⇧' : 'shift';\r\n            var plus = ismac ? '' : '+';\r\n\r\n            jsbin.$document.trigger('tip', {\r\n              type: 'notification',\r\n              content: 'You\\'re currently viewing someone else\\'s live stream, but you can <strong><a class=\"clone\" href=\"' + jsbin.root + '/clone\">clone your own copy</a></strong> (' + cmd + plus + shift + plus + 'S) at any time to save your edits'\r\n            });\r\n          }\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  function compressKeys(keys, obj) {\r\n    obj.compressed = keys;\r\n    keys.split(',').forEach(function (key) {\r\n      obj[key] = LZString.compressToUTF16(obj[key]);\r\n    });\r\n  }\r\n\r\n  function updateCode(panelId, callback) {\r\n    var panelSettings = {};\r\n\r\n    if (jsbin.state.processors) {\r\n      panelSettings.processors = jsbin.state.processors;\r\n    }\r\n\r\n    var data = {\r\n      code: jsbin.state.code,\r\n      revision: jsbin.state.revision,\r\n      method: 'update',\r\n      panel: panelId,\r\n      content: panels.named[panelId].getCode(),\r\n      checksum: jsbin.saveChecksum,\r\n      settings: JSON.stringify(panelSettings),\r\n    };\r\n\r\n    if (jsbin.settings.useCompression && location.protocol === 'http:') {\r\n      compressKeys('content', data);\r\n    }\r\n\r\n    if (jsbin.state.processors[panelId] &&\r\n      jsbin.state.processors[panelId] !== panelId &&\r\n      jsbin.state.cache[panelId]) {\r\n      data.processed = jsbin.state.cache[panelId].result;\r\n    }\r\n\r\n    $.ajax({\r\n      url: jsbin.getURL({ withRevision: true }) + '/save',\r\n      data: data,\r\n      type: 'post',\r\n      dataType: 'json',\r\n      headers: {'Accept': 'application/json'},\r\n      success: function (data) {\r\n        jsbin.$document.trigger('saveComplete', { panelId: panelId });\r\n        if (data.error) {\r\n          saveCode('save', true, function () {\r\n            // savedAlready = data.checksum;\r\n          });\r\n        } else {\r\n          jsbin.state.latest = true;\r\n        }\r\n      },\r\n      error: function (jqXHR) {\r\n        onSaveError(jqXHR, panelId);\r\n      },\r\n      complete: function () {\r\n        saving.inprogress(false);\r\n        if (callback) { callback(); }\r\n      }\r\n    });\r\n  }\r\n\r\n  $('a.clone').click(clone);\r\n  $('#tip').delegate('a.clone', 'click', clone);\r\n\r\n  function clone(event) {\r\n    event.preventDefault();\r\n\r\n    // save our panel layout - assumes our user is happy with this layout\r\n    jsbin.panels.save();\r\n    analytics.clone();\r\n\r\n    var $form = setupform('save,new');\r\n    $form.submit();\r\n\r\n    return false;\r\n  }\r\n\r\n  function setupform(method) {\r\n  var $form = $('form#saveform').empty()\r\n      .append('<input type=\"hidden\" name=\"javascript\" />')\r\n      .append('<input type=\"hidden\" name=\"html\" />')\r\n      .append('<input type=\"hidden\" name=\"css\" />')\r\n      .append('<input type=\"hidden\" name=\"method\" />')\r\n      .append('<input type=\"hidden\" name=\"_csrf\" value=\"' + jsbin.state.token + '\" />')\r\n      .append('<input type=\"hidden\" name=\"settings\" />')\r\n      .append('<input type=\"hidden\" name=\"checksum\" />');\r\n\r\n    var settings = {};\r\n\r\n    if (jsbin.state.processors) {\r\n      settings.processors = jsbin.state.processors;\r\n    }\r\n\r\n    // this prevents new revisions forking off the welcome bin\r\n    // because it's looking silly!\r\n    if (jsbin.state.code === 'welcome') {\r\n      $form.attr('action', '/save');\r\n    }\r\n\r\n    $form.find('input[name=settings]').val(JSON.stringify(settings));\r\n    $form.find('input[name=javascript]').val(editors.javascript.getCode());\r\n    $form.find('input[name=css]').val(editors.css.getCode());\r\n    $form.find('input[name=html]').val(editors.html.getCode());\r\n    $form.find('input[name=method]').val(method);\r\n    $form.find('input[name=checksum]').val(jsbin.state.checksum);\r\n\r\n    return $form;\r\n  }\r\n\r\n  function pad(n){\r\n    return n<10 ? '0'+n : n;\r\n  }\r\n\r\n  function ISODateString(d){\r\n    return d.getFullYear()+'-'\r\n      + pad(d.getMonth()+1)+'-'\r\n      + pad(d.getDate())+'T'\r\n      + pad(d.getHours())+':'\r\n      + pad(d.getMinutes())+':'\r\n      + pad(d.getSeconds())+'Z';\r\n  }\r\n\r\n  function saveCode(method, ajax, ajaxCallback) {\r\n    // create form and post to it\r\n    var $form = setupform(method);\r\n    // save our panel layout - assumes our user is happy with this layout\r\n    jsbin.panels.save();\r\n    jsbin.panels.saveOnExit = true;\r\n\r\n    var data = $form.serializeArray().reduce(function(obj, data) {\r\n      obj[data.name] = data.value;\r\n      return obj;\r\n    }, {});\r\n\r\n    if (jsbin.settings.useCompression) {\r\n      compressKeys('html,css,javascript', data);\r\n    }\r\n\r\n    if (ajax) {\r\n      $.ajax({\r\n        url: jsbin.getURL({ withRevision: true }) + '/save',\r\n        data: data,\r\n        dataType: 'json',\r\n        type: 'post',\r\n        headers: {'Accept': 'application/json'},\r\n        success: function (data) {\r\n          if (ajaxCallback) {\r\n            ajaxCallback(data);\r\n          }\r\n\r\n          store.sessionStorage.setItem('checksum', data.checksum);\r\n          saveChecksum = data.checksum;\r\n\r\n          jsbin.state.checksum = saveChecksum;\r\n          jsbin.state.code = data.code;\r\n          jsbin.state.revision = data.revision;\r\n          jsbin.state.latest = true; // this is never not true...end of conversation!\r\n          jsbin.state.metadata = { name: jsbin.user.name };\r\n          $form.attr('action', jsbin.getURL({ withRevision: true }) + '/save');\r\n\r\n          if (window.history && window.history.pushState) {\r\n            // updateURL(edit);\r\n            var hash = panels.getHighlightLines();\r\n            if (hash) { hash = '#' + hash; }\r\n            var query = panels.getQuery();\r\n            if (query) { query = '?' + query; }\r\n            // If split is truthy (> 0) then we are using the revisonless feature\r\n            // this is temporary until we release the feature!\r\n            window.history.pushState(null, '', jsbin.getURL({withRevision: !split}) + '/edit' + query + hash);\r\n            store.sessionStorage.setItem('url', jsbin.getURL({withRevision: !split}));\r\n          } else {\r\n            window.location.hash = data.edit;\r\n          }\r\n\r\n          jsbin.$document.trigger('saved');\r\n        },\r\n        error: function (jqXHR) {\r\n          onSaveError(jqXHR, null);\r\n        },\r\n        complete: function () {\r\n          saving.inprogress(false);\r\n        }\r\n      });\r\n    } else {\r\n      $form.submit();\r\n    }\r\n  }\r\n\r\n});"]}